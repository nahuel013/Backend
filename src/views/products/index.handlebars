<h1>{{title}}</h1>

<section>
	<h2>Productos</h2>
	
	<!-- Filtros y ordenamiento -->
	<div style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 5px;">
		<form method="GET" action="/products" style="display: flex; gap: 10px; flex-wrap: wrap; align-items: end;">
			<div>
				<label for="query">Buscar:</label>
				<input type="text" name="query" id="query" value="{{filters.query}}" placeholder="Título, descripción..." style="padding: 5px; width: 200px;">
			</div>
			
			<div>
				<label for="category">Categoría:</label>
				<select name="category" id="category" style="padding: 5px;">
					<option value="">Todas</option>
					{{#each categories}}
					<option value="{{this}}" {{#if (eq ../filters.category this)}}selected{{/if}}>{{this}}</option>
					{{/each}}
				</select>
			</div>
			
			<div>
				<label for="status">Disponibilidad:</label>
				<select name="status" id="status" style="padding: 5px;">
					<option value="">Todas</option>
					<option value="true" {{#if (eq filters.status "true")}}selected{{/if}}>Disponible</option>
					<option value="false" {{#if (eq filters.status "false")}}selected{{/if}}>No disponible</option>
				</select>
			</div>
			
			<div>
				<label for="sort">Ordenar por precio:</label>
				<select name="sort" id="sort" style="padding: 5px;">
					<option value="">Sin ordenar</option>
					<option value="asc" {{#if (eq filters.sort "asc")}}selected{{/if}}>Menor a mayor</option>
					<option value="desc" {{#if (eq filters.sort "desc")}}selected{{/if}}>Mayor a menor</option>
				</select>
			</div>
			
			<div>
				<label for="limit">Productos por página:</label>
				<select name="limit" id="limit" style="padding: 5px;">
					<option value="5" {{#if (eq pagination.limit 5)}}selected{{/if}}>5</option>
					<option value="10" {{#if (eq pagination.limit 10)}}selected{{/if}}>10</option>
					<option value="20" {{#if (eq pagination.limit 20)}}selected{{/if}}>20</option>
					<option value="50" {{#if (eq pagination.limit 50)}}selected{{/if}}>50</option>
				</select>
			</div>
			
			<button type="submit" style="padding: 5px 15px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">Filtrar</button>
			<a href="/products" style="padding: 5px 15px; background: #6c757d; color: white; text-decoration: none; border-radius: 3px; display: inline-block;">Limpiar</a>
		</form>
	</div>
	
	{{#if products.length}}
	<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px;">
		{{#each products}}
		<div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
			{{#if this.thumbnails.[0]}}
			<img src="{{this.thumbnails.[0]}}" alt="{{this.title}}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 4px; margin-bottom: 10px;">
			{{else}}
			<div style="width: 100%; height: 200px; background: #f0f0f0; border-radius: 4px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; color: #999;">
				Sin imagen
			</div>
			{{/if}}
			
			<h3 style="margin: 0 0 10px 0; font-size: 1.2em; color: #333;">
				<a href="/products/{{this._id}}" style="text-decoration: none; color: #007bff;">{{this.title}}</a>
			</h3>
			
			<p style="margin: 0 0 10px 0; color: #666; font-size: 0.9em; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
				{{this.description}}
			</p>
			
			<div style="margin-bottom: 10px;">
				<span style="font-size: 1.5em; font-weight: bold; color: #28a745;">${{this.price}}</span>
				<span style="color: #666; margin-left: 10px;">Stock: {{this.stock}}</span>
			</div>
			
			<div style="margin-bottom: 10px;">
				<span style="background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-size: 0.85em;">{{this.category}}</span>
				{{#if this.status}}
				<span style="background: #d4edda; color: #155724; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; margin-left: 5px;">Disponible</span>
				{{else}}
				<span style="background: #f8d7da; color: #721c24; padding: 4px 8px; border-radius: 4px; font-size: 0.85em; margin-left: 5px;">No disponible</span>
				{{/if}}
			</div>
			
			<div style="display: flex; gap: 10px;">
				<a href="/products/{{this._id}}" style="flex: 1; padding: 8px; background: #007bff; color: white; text-decoration: none; text-align: center; border-radius: 4px; font-size: 0.9em;">
					Ver detalles
				</a>
				<button onclick="addToCart('{{this._id}}')" style="flex: 1; padding: 8px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
					Agregar al carrito
				</button>
			</div>
		</div>
		{{/each}}
	</div>
	
	<!-- Paginación -->
	<div style="margin-top: 20px; display: flex; justify-content: center; align-items: center; gap: 10px;">
		{{#if pagination.hasPrevPage}}
		<a href="/products?page={{pagination.prevPage}}&limit={{pagination.limit}}{{#if filters.query}}&query={{filters.query}}{{/if}}{{#if filters.category}}&category={{filters.category}}{{/if}}{{#if filters.status}}&status={{filters.status}}{{/if}}{{#if filters.sort}}&sort={{filters.sort}}{{/if}}" 
		   style="padding: 8px 15px; background: #007bff; color: white; text-decoration: none; border-radius: 3px;">← Anterior</a>
		{{/if}}
		
		<span style="padding: 8px 15px;">
			Página {{pagination.page}} de {{pagination.totalPages}} ({{pagination.totalProducts}} productos)
		</span>
		
		{{#if pagination.hasNextPage}}
		<a href="/products?page={{pagination.nextPage}}&limit={{pagination.limit}}{{#if filters.query}}&query={{filters.query}}{{/if}}{{#if filters.category}}&category={{filters.category}}{{/if}}{{#if filters.status}}&status={{filters.status}}{{/if}}{{#if filters.sort}}&sort={{filters.sort}}{{/if}}" 
		   style="padding: 8px 15px; background: #007bff; color: white; text-decoration: none; border-radius: 3px;">Siguiente →</a>
		{{/if}}
	</div>
	{{else}}
	<p>No hay productos disponibles.</p>
	{{/if}}
</section>

<script>
	// Función para agregar al carrito (necesitarás un cartId, puedes usar localStorage o crear uno)
	async function addToCart(productId) {
		try {
			// Obtener o crear cartId
			let cartId = localStorage.getItem('cartId');
			
			if (!cartId) {
				// Crear un nuevo carrito
				const response = await fetch('/api/carts', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json'
					}
				});
				const data = await response.json();
				if (data.success) {
					cartId = data.data._id;
					localStorage.setItem('cartId', cartId);
				} else {
					throw new Error('Error al crear carrito');
				}
			}
			
			// Agregar producto al carrito
			const addResponse = await fetch(`/api/carts/${cartId}/product/${productId}`, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				}
			});
			
			const addData = await addResponse.json();
			
			if (addData.success) {
				alert('Producto agregado al carrito exitosamente');
				// Actualizar enlace del carrito en el header
				updateCartLink(cartId);
				// Opcional: redirigir al carrito
				if (confirm('¿Deseas ver tu carrito?')) {
					window.location.href = `/carts/${cartId}`;
				}
			} else {
				throw new Error(addData.error || 'Error al agregar producto');
			}
		} catch (error) {
			alert('Error: ' + error.message);
			console.error('Error:', error);
		}
	}
	
	// Función para actualizar el enlace del carrito en el header
	function updateCartLink(cartId) {
		const cartLink = document.getElementById('cartLink');
		const cartLinkAnchor = document.getElementById('cartLinkAnchor');
		if (cartLink && cartLinkAnchor) {
			cartLink.style.display = 'block';
			cartLinkAnchor.href = `/carts/${cartId}`;
		}
	}
	
	// Mostrar enlace del carrito si existe uno guardado
	window.addEventListener('DOMContentLoaded', () => {
		const cartId = localStorage.getItem('cartId');
		if (cartId) {
			updateCartLink(cartId);
		}
	});
</script>

